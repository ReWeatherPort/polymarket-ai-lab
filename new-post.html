<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ç™¼è¡¨æ–‡ç«  - Polymarket AI Lab</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicon/favicon.svg">
  <link rel="stylesheet" href="assets/css/vars.css">
  <style>
    /* Page-level styles â€” color variables are defined in assets/css/vars.css */
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    a.logo{font-weight:700;color:var(--color-primary);text-decoration:none}
    .container{max-width:1100px;margin:0 auto}
    .editor{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px}
    input[type=text]{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px}
    textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono','Segoe UI Mono',monospace;font-size:14px;line-height:1.5;color:var(--text);min-height:220px}
    .controls{display:flex;gap:8px;margin-top:8px}
    .btn{padding:10px 14px;border-radius:8px;background:var(--color-primary);color:white;text-decoration:none;border:none;cursor:pointer}
    .btn-ghost{background:transparent;color:var(--color-primary);border:1px solid var(--color-primary);padding:8px 10px;border-radius:6px}
    .btn-ghost:hover{background:rgba(50,168,194,0.06)}
    label{display:block;font-weight:600;margin-bottom:6px}
    .meta{display:flex;gap:12px;align-items:center}
    .preview{height:70vh;overflow:auto;padding:18px;background:var(--surface);border-radius:6px;border:1px solid var(--border)}
    .preview h1,.preview h2,.preview h3{color:var(--text)}
    .preview p{color:var(--muted)}
    .preview pre{background:var(--code-bg);color:var(--code-text);padding:12px;border-radius:6px;overflow:auto}
    .preview code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono','Segoe UI Mono',monospace;font-size:13px}
    .note{font-size:13px;color:var(--muted);margin-top:8px}
    #toolbar button{min-width:40px;min-height:36px;border-radius:6px}
    .toolbar-icon{font-weight:700}
    .muted{color:var(--muted)}
    @media(max-width:900px){.editor{grid-template-columns:1fr;}.preview{height:50vh}}
  </style>
</head>
<body>

  <nav>
  <a href="index.html" class="logo">ğŸš€ Polymarket AI Lab</a>
  <ul>
    <li><a class="nav-pill" href="experiments/index.html">å¯¦é©—</a></li>
    <li><a class="nav-pill" href="tools.html">å·¥å…·</a></li>
    <li><a class="nav-pill" href="new-post.html">ç™¼è¡¨</a></li>
    <li><a class="nav-pill" href="#news">News</a></li>
    <li><a class="nav-pill" href="#guides">æ•™å­¸</a></li>
    <li><a class="nav-pill" href="#about">é—œæ–¼</a></li>
    <li><button id="themeToggle" class="btn-ghost" aria-label="åˆ‡æ›ä¸»é¡Œ">ğŸŒ™</button></li>
  </ul>
</nav>

  <div class="container">

    <h1>ç™¼è¡¨æ–°æ–‡ç« </h1>
    <p class="note">ä½¿ç”¨ Markdown ç·¨å¯«ã€‚æŒ‰ã€Œä¸‹è¼‰ Markdownã€æŠŠæª”æ¡ˆæ”¾åˆ° `content/posts/`ï¼Œå†åœ¨ repo åŸ·è¡Œ `python .\scripts\generate_posts_manifest.py` ä¸¦æ¨ä¸Š GitHubï¼Œå³å¯åœ¨ç¶²ç«™ä¸Šçœ‹åˆ°æ–‡ç« ã€‚</p>

    <div class="editor" style="margin-top:12px">
      <div class="panel">
        <label for="title">æ¨™é¡Œ</label>
        <input id="title" type="text" placeholder="è¼¸å…¥æ–‡ç« æ¨™é¡Œ" />

        <label for="tags" style="margin-top:10px">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
        <input id="tags" type="text" placeholder="ä¾‹: OKC, experiment, notes" />

        <label for="excerpt" style="margin-top:10px">æ‘˜è¦ï¼ˆç¬¬ä¸€æ®µï¼Œæœƒé¡¯ç¤ºåœ¨é¦–é ï¼‰</label>
        <input id="excerpt" type="text" placeholder="å¯«ä¸€æ®µç°¡çŸ­æ‘˜è¦" />

        <label for="slug" style="margin-top:10px">æª”å / slugï¼ˆé¸å¡«ï¼Œé è¨­ç”±æ¨™é¡Œç”¢ç”Ÿï¼‰</label>
        <input id="slug" type="text" placeholder="ä¾‹å¦‚: okc-low-price-2025-12" />

        <label for="md" style="margin-top:10px">Markdown å…§å®¹</label>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <div id="toolbar" style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn-ghost toolbar-icon" data-act="bold">B</button>
            <button class="btn-ghost toolbar-icon" data-act="italic">i</button>
            <button class="btn-ghost toolbar-icon" data-act="h2">H2</button>
            <button class="btn-ghost toolbar-icon" data-act="code">`</button>
            <button class="btn-ghost toolbar-icon" data-act="link">ğŸ”—</button>
            <button class="btn-ghost toolbar-icon" id="imageBtn">ğŸ–¼ï¸</button>
          </div>
          <div style="margin-left:auto;color:var(--muted);font-size:13px">æ”¯æ´æ‹–æ”¾åœ–ç‰‡æˆ–è²¼ä¸Šåœ–ç‰‡ï¼ˆæœƒå…§åµŒç‚º data URLï¼‰</div>
        </div>
        <input id="imageInput" type="file" accept="image/*" style="display:none" />
        <textarea id="md" rows="14" placeholder="åœ¨é€™è£¡æ’°å¯«ä½ çš„æ–‡ç« ï¼ˆæ”¯æ´æ¨™æº– Markdownï¼‰"></textarea>

        <div class="controls">
          <button id="downloadBtn" class="btn">ä¸‹è¼‰ Markdown</button>
          <button id="previewBtn" class="btn-ghost">æ›´æ–°é è¦½</button>
          <button id="publishBtn" class="btn">ç™¼ä½ˆåˆ° GitHubï¼ˆé¸å¡«ï¼‰</button>
        </div>

        <p class="note">æ³¨æ„ï¼šç›´æ¥ç™¼ä½ˆåˆ° GitHub éœ€è¦ä¸€å€‹æœ‰ repo å¯«å…¥æ¬Šé™çš„ Personal Access Tokenï¼ˆrepo scopeï¼‰ã€‚Token ä¸æœƒè¢«å„²å­˜åœ¨ä¼ºæœå™¨ä¸Šï¼Œåƒ…åœ¨ä½ çš„ç€è¦½å™¨ä¸­ä½¿ç”¨ã€‚</p>
      </div>

      <div class="panel">
        <h3>å³æ™‚é è¦½</h3>
        <div id="preview" class="preview">é è¦½æœƒåœ¨ä½ æŒ‰ã€Œæ›´æ–°é è¦½ã€æˆ–ç·¨è¼¯æ™‚è‡ªå‹•é¡¯ç¤ºã€‚</div>
        <div style="margin-top:12px">
          <label for="ghToken">GitHub Tokenï¼ˆå¯é¸ï¼Œç›´æ¥åœ¨ repo å»ºæª”ï¼‰</label>
          <input id="ghToken" type="text" placeholder="ghp_xxx...ï¼ˆå»ºè­°ä½¿ç”¨çŸ­æœŸ tokenï¼‰" />
          <label for="ghPath" style="margin-top:8px">å„²å­˜è·¯å¾‘ï¼ˆç›¸å° repoï¼‰</label>
          <input id="ghPath" type="text" value="content/posts/" />
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/common.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
  <script>
    const titleEl = document.getElementById('title');
    const tagsEl = document.getElementById('tags');
    const excerptEl = document.getElementById('excerpt');
    const slugEl = document.getElementById('slug');
    const mdEl = document.getElementById('md');
    const previewEl = document.getElementById('preview');
    const downloadBtn = document.getElementById('downloadBtn');
    const previewBtn = document.getElementById('previewBtn');
    const publishBtn = document.getElementById('publishBtn');
    const imageInput = document.getElementById('imageInput');
    const imageBtn = document.getElementById('imageBtn');

    // Utilities
    function slugify(s){
      return (s||'').toString().toLowerCase().trim()
        .replace(/\s+/g,'-')
        .replace(/[^a-z0-9-]/g,'')
        .replace(/-+/g,'-');
    }

    function generateFrontmatter(){
      const title = titleEl.value.trim() || 'Untitled';
      const date = new Date().toISOString().split('T')[0];
      const tags = tagsEl.value.split(',').map(t=>t.trim()).filter(Boolean);
      const excerpt = excerptEl.value.trim();
      const slug = slugEl.value.trim() || slugify(title) || `post-${Date.now()}`;
      const path = `content/posts/${slug}.md`;
      const fmLines = ['---', `title: "${title.replace(/"/g,'\"')}"`, `date: ${date}`, `excerpt: "${excerpt.replace(/"/g,'\"')}"`, `tags: [${tags.map(t=>`"${t.replace(/"/g,'\"')}"`).join(', ')}]`, `path: ${path}`, '---\n\n'];
      const fm = fmLines.join('\n');
      return {fm, slug, path};
    }

    // Markdown preview with highlight
    function renderPreview(){
      const {fm} = generateFrontmatter();
      const content = fm + mdEl.value;
      const html = marked.parse(content);
      previewEl.innerHTML = html;
      document.querySelectorAll('pre code').forEach((block) => {
        try{ hljs.highlightElement(block); }catch(e){}
      });
    }

    // Debounce helper for live preview
    function debounce(fn, wait){
      let t;
      return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); };
    }

    const livePreview = debounce(renderPreview, 300);

    // Insert/replace helper for textarea
    function insertAtCursor(textarea, insertion){
      const start = textarea.selectionStart || 0;
      const end = textarea.selectionEnd || 0;
      const before = textarea.value.substring(0, start);
      const after = textarea.value.substring(end);
      textarea.value = before + insertion + after;
      const pos = before.length + insertion.length;
      textarea.selectionStart = textarea.selectionEnd = pos;
      textarea.focus();
      livePreview();
    }

    function wrapSelection(textarea, left, right){
      const start = textarea.selectionStart || 0;
      const end = textarea.selectionEnd || 0;
      const sel = textarea.value.substring(start, end) || '';
      const replacement = left + sel + right;
      textarea.setRangeText(replacement, start, end, 'end');
      textarea.focus();
      livePreview();
    }

    // Toolbar actions
    document.getElementById('toolbar').addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const act = btn.getAttribute('data-act');
      if(!act) return;
      if(act === 'bold') wrapSelection(mdEl, '**', '**');
      if(act === 'italic') wrapSelection(mdEl, '*', '*');
      if(act === 'h2') insertAtCursor(mdEl, '\n\n## ');
      if(act === 'code') wrapSelection(mdEl, '`', '`');
      if(act === 'link'){
        const url = prompt('è¼¸å…¥é€£çµ URL');
        if(url) insertAtCursor(mdEl, `[link text](${url})`);
      }
    });

    // Image upload & drag/drop/paste handlers
    imageBtn.addEventListener('click', ()=> imageInput.click());
    imageInput.addEventListener('change', async (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;
      const data = await fileToDataUrl(f);
      const name = f.name.replace(/\s+/g,'-');
      insertAtCursor(mdEl, `![${name}](${data})`);
      imageInput.value = '';
    });

    async function fileToDataUrl(file){
      return await new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = ()=> res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }

    // Drag & drop
    mdEl.addEventListener('dragover', (e)=>{ e.preventDefault(); mdEl.style.outline = '2px dashed var(--color-primary-light)'; });
    mdEl.addEventListener('dragleave', (e)=>{ mdEl.style.outline = ''; });
    mdEl.addEventListener('drop', async (e)=>{
      e.preventDefault(); mdEl.style.outline = '';
      const items = e.dataTransfer.files;
      if(items && items.length){
        for(const f of items){ if(f.type.startsWith('image/')){
            const data = await fileToDataUrl(f);
            insertAtCursor(mdEl, `![${f.name}](${data})`);
          } else {
            // non-image: ignore or insert filename
            insertAtCursor(mdEl, `\n\n[${f.name}]`);
          }
        }
      }
    });

    // Paste image support
    mdEl.addEventListener('paste', async (e)=>{
      const items = e.clipboardData && e.clipboardData.items;
      if(!items) return;
      for(const it of items){
        if(it.kind === 'file' && it.type.startsWith('image/')){
          const f = it.getAsFile();
          const data = await fileToDataUrl(f);
          insertAtCursor(mdEl, `![pasted-image](${data})`);
          e.preventDefault();
          return;
        }
      }
    });

    // Live preview while typing
    mdEl.addEventListener('input', livePreview);
    titleEl.addEventListener('input', livePreview);
    tagsEl.addEventListener('input', livePreview);
    excerptEl.addEventListener('input', livePreview);

    // explicit preview button
    if (previewBtn) previewBtn.addEventListener('click', renderPreview);

    // Download
    downloadBtn.addEventListener('click', () => {
      const {fm, slug, path} = generateFrontmatter();
      const content = fm + mdEl.value + '\n';
      const blob = new Blob([content], {type: 'text/markdown;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = slug + '.md';
      document.body.appendChild(a);
      a.click();
      a.remove();
      if (window.showToast) showToast('å·²ç”¢ç”Ÿ Markdown æª”ï¼Œè«‹æŠŠå®ƒæ”¾åˆ° repo çš„ content/posts/ï¼Œç„¶å¾ŒåŸ·è¡Œ scripts/generate_posts_manifest.py ä¸¦æ¨åˆ° GitHubã€‚', {timeout:6000});
    });

    // Publish to GitHub: create-or-update (handles existing file by fetching sha)
    async function publishToGitHub(){
      const token = document.getElementById('ghToken').value.trim();
      if(!token){
        if(!confirm('ä½ ç¢ºå®šè¦ç›´æ¥ç™¼ä½ˆåˆ° GitHub å—ï¼Ÿ éœ€æä¾› Personal Access Tokenï¼ˆrepo æ¬Šé™ï¼‰ã€‚')) return;
      }
      const {fm, slug, path} = generateFrontmatter();
      const content = fm + mdEl.value + '\n';
      const repoOwner = 'ReWeatherPort';
      const repoName = 'polymarket-ai-lab';
      const branch = 'main';
      const apiPath = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
      const headers = { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' };

      publishBtn.disabled = true;
      const prevLabel = publishBtn.textContent;
      publishBtn.textContent = 'ç™¼ä½ˆä¸­â€¦';

      try{
        // check if file exists to get sha (for update)
        let sha = null;
        try{
          const getRes = await fetch(apiPath + `?ref=${branch}`, { method: 'GET', headers });
          if (getRes.ok){
            const getData = await getRes.json();
            sha = getData.sha;
          }
        }catch(e){ /* ignore - file may not exist */ }

        // proper base64 for unicode (robust)
        const uint8 = new TextEncoder().encode(content);
        let binary = '';
        for (let i=0;i<uint8.length;i++) binary += String.fromCharCode(uint8[i]);
        const base64 = btoa(binary);

        const body = { message: `chore(posts): add ${slug}`, content: base64, branch };
        if (sha) body.sha = sha; // include sha if updating

        const res = await fetch(apiPath, { method: 'PUT', headers: { ...headers, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const data = await res.json();
        if(res.ok){
          const url = data.content && data.content.html_url ? data.content.html_url : `https://github.com/${repoOwner}/${repoName}/blob/${branch}/${path}`;
          if (window.showToast) showToast('å·²ç™¼ä½ˆåˆ° GitHubï¼š ' + url, {timeout:8000});
          else alert('å·²ç™¼ä½ˆåˆ° GitHubï¼š ' + url);
        } else {
          console.error('Publish error', data);
          let msg = data && data.message ? data.message : 'Unknown error';
          if (data && data.errors) msg += '\n' + JSON.stringify(data.errors);
          if (window.showToast) showToast('ç™¼ä½ˆå¤±æ•—ï¼š' + msg, {type:'error', timeout:8000});
          else alert('ç™¼ä½ˆå¤±æ•—ï¼š' + msg);
        }
      }catch(err){
        console.error(err);
        if (window.showToast) showToast('ç™¼ä½ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message, {type:'error'});
        else alert('ç™¼ä½ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
      } finally {
        publishBtn.disabled = false;
        publishBtn.textContent = prevLabel;
      }
    }

    publishBtn.addEventListener('click', publishToGitHub);

    // initial sample content
    mdEl.value = "æ­¡è¿ä½¿ç”¨ Polymarket AI Lab çš„ç™¼è¡¨å·¥å…·ã€‚\n\nåœ¨æ­¤æ’°å¯«ä½ çš„å¯¦é©—æ—¥èªŒã€è§€å¯Ÿæˆ–æ•™å­¸ã€‚\n\n## ç¯„ä¾‹å°ç¯€\n\n- æ¢ç›® 1\n- æ¢ç›® 2\n\n```ç¨‹å¼ç¢¼ç¯„ä¾‹```\n\n";
    renderPreview();
  </script>
  <script>
    (function(){
      const btn=document.getElementById('themeToggle'); if(!btn) return;
      const setTheme=(t)=>{document.documentElement.setAttribute('data-theme',t);btn.textContent=t==='dark'?'â˜€ï¸':'ğŸŒ™'};
      const stored=localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      setTheme(stored || (prefersDark ? 'dark' : 'light'));
      btn.addEventListener('click', ()=>{const cur=document.documentElement.getAttribute('data-theme');const nxt=cur==='dark'?'light':'dark';setTheme(nxt);localStorage.setItem('theme',nxt);});
    })();
  </script>
  <script src="assets/js/ui.js"></script>
</body>
</html>
